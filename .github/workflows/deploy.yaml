name: Deploy App

on:
  workflow_dispatch:
    inputs:
      image:
        description: 'Image'
        required: true
        type: choice
        options:
          - 'pr'
          - 'main'
      environment:
        description: 'Environment'
        required: true
        type: choice
        options:
          - 'dev'
          - 'production'

jobs:

  check_if_allowed:
    runs-on: self-hosted
    steps:
      - name: Check
        run: |
          if [[ "${{ github.event.inputs.environment }}" == "production" && "${{ github.event.inputs.image }}" == "pr" ]]; then
            echo "ERROR: Can't deploy PR image to the production environment" >&2
            exit 1
          fi

  deploy_petclinic:

    runs-on: self-hosted
    needs: check_if_allowed
    steps:
  
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Authenticate
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
  
      - name: Gcloud Setup
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.PROJECT }}

      - name: Configure GKE credentials
        run: |
          if [[ "${{ github.event.inputs.environment }}" == "production" ]]; then
            gcloud container clusters get-credentials ${{ secrets.MAIN_CLUSTER_NAME }} --zone ${{ secrets.ZONE }}
          else
            gcloud container clusters get-credentials ${{ secrets.DEV_CLUSTER_NAME }} --zone ${{ secrets.ZONE }}
          fi

      - name: Install kubectl
        run: gcloud components install kubectl

      - name: Install unzip
        run: sudo apt-get update && sudo apt-get install -y unzip

      - name: Install Helm
        run: |
          wget https://get.helm.sh/helm-v3.13.0-linux-amd64.tar.gz -O helm.tar.gz
          tar -zxvf helm.tar.gz
          sudo mv linux-amd64/helm /usr/local/bin/helm
      
      - name: Install Chart
        run: |
          if [[ "${{ github.event.inputs.image }}" == "main" ]]; then
            IMAGE="${{ vars.REGION }}-docker.pkg.dev/${{ secrets.PROJECT }}/${{ secrets.MAIN_REPO }}/spring-petclinic:latest"
          else
            IMAGE="${{ vars.REGION }}-docker.pkg.dev/${{ secrets.PROJECT }}/${{ secrets.PR_REPO }}/spring-petclinic:latest"
          fi

          if [[ "${{ github.event.inputs.environment }}" == "production" ]]; then
            DB_NAME=${{ secrets.PRODUCTION_DB_NAME }}
          else
            DB_NAME=${{ secrets.DEV_DB_NAME }}
          fi
          
          helm dependency build ./helm/petclinic/
          helm upgrade --install petclinic ./helm/petclinic/ \
            --set deployment.image=$IMAGE \
            --set db.url=${{ secrets.DB_HOST }} \
            --set db.name=$DB_NAME \
            --set db.user=${{ secrets.DB_USER }} \
            --set db.password=${{ secrets.DB_PASSWORD }}

      - name: Get Application Link
        run: |
          ip=$( kubectl get svc ${{ secrets.SVC_NAME }} | grep "LoadBalancer" | awk '{ print $4 }' )
          while [[ $ip == "<pending>" ]]; do
            ip=$( kubectl get svc ${{ secrets.SVC_NAME }} | grep "LoadBalancer" | awk '{ print $4 }' )
          done
          echo "http://${ip}:80"
